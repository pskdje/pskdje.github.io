<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>audio play</title>
		<script src="/js/script.js"></script>
		<script src="/js/monitor.js"></script>
		<link rel="stylesheet" href="//unpkg.com/layui@2.9.21/dist/css/layui.css" />
		<style>
			/*  */
.s-bacl {
	background-color: var(--docs-bacl);
}
#player {
	width: 35%;
}
#playtext {
	position: absolute;
	top: 0;
	right: 0;
	height: calc(2em + 2px);
	width: calc(65% - 0.5em);
	font-size: 2em;
}
body {
	--scroll-behavor: smooth;
}
.playlistdata :where(.layui-table-body , tbody) {
	scroll-behavior: var(--scroll-behavor);
}
@media(prefers-reduced-motion:reduce){
	body {
		--scroll-behavor: auto;
	}
}
@media(max-width:650px){
	#player {
		width: 100%;
	}
	#playtext {
		display: none;
	}
	.opt-win-cont {
		width: 200px;
	}
	.layui-form-checkbox[lay-skin=primary]>div {
		white-space: pre-line;
	}
}
			/*  */
		</style>
	</head>
	<body>
		<audio id="player" class="layui-show" controls crossorigin="anonymous" autoplay></audio>
		<p id="playtext"></p>
		<p class="s-bacl">
			<span>操作: </span>
			<button id="getdatabutton" type="button" class="layui-btn layui-btn-xs" title="不要使用不安全的数据">获取数据</button>
			<button id="showoptionwin" type="button" class="layui-btn layui-btn-xs">修改配置</button>
			<button type="button" class="layui-btn layui-btn-xs layui-btn-primary"><a target="_blank" href="/docs/changelog.html?href=audioplay.html">查看更新日志</a></button>
		</p>
		<table id="playlist" class="layui-table" lay-options="{height:'full-80',limit:Infinity,className:'playlistdata s-bacl'}">
			<thead>
				<tr>
					<th lay-options="{field:'title'}">标题</th>
					<th lay-options="{field:'type'}">类型</th>
					<th lay-options="{field:'args',hide:true,style:'font-family:Consolas,Courier,monospace;'}">参数</th>
				</tr>
			</thead>
		</table>
		<script src="/js/evaltool.js"></script>
		<script src="//unpkg.com/layui@2.9.21/dist/layui.js"></script>
		<script>
			// 还是不手搓太多功能了
const id_player=document.getElementById("player");
const id_playtext=document.getElementById("playtext");
const urlsea=docsScript.pageData.search;
const playlist=[];// 播放列表(数据层面)
const uiText=Object.seal({// UI文本(预留I18N)
	playtext:"正在播放:",
	playtext_none:"无",
	playtitle_play:"play:",
	playtitle_pause:"pause:",
	getdatabutton:"获取数据",
	showoptionwin:"修改配置",
	// 播放列表
	pl_title:"标题",
	pl_type:"类型",
	pl_args:"参数",
	// 数据处理
	cd_calldatatypeerr:"调用列表格式错误",
	cd_playlist_typeerr:"播放列表类型错误，请提供正确的播放列表。",
	// 播放
	pa_none_type:"播放操作无效",
	pe_msg0:"播放",
	pe_msg1:"失败，自动播放下一个。",
	pe_msg2:"标题:",
	pe_errconmax:"累计播放失败次数超过阈值，已停止自动切换下一个。请检查播放列表是否可用。",
	is_running:"当前正在处理歌曲信息，暂时不可切换。",
	psl_err:"阻止屏幕锁定失败",
	// 文件获取
	readfiletitle:"读取文件",
	readfilecontent:"点击获取文件，或拖拽文件至此。",
	// 网络
	nw_wwtitle:"输入要获取文件的url",
	nw_urlerr:"无法解析该URL数据",
	nw_getting:"获取网络文件中…",
	nw_error:"由于网络或策略原因，获取数据失败。",
	// 配置
	opt_title:"配置",
	opt_ok:"确定",
	opt_cancel:"取消",// 下面那些都没有写输入检查，不要老想着注入口牙！
	opt_NAPN:"是否不播放下一个",
	opt_SPT:"是否显示播放时间",
	opt_PSL:"是否阻止屏幕锁定",
	opt_SRN:"是否强制修改为未在运行\n若正常运行时强行修改可能会出现问题",
	// 获取选项
	gdb_XZCZ:"选择数据获取的操作",
	gdb_QX:"取消",
	gdb_BDSJ:"本地数据",
	gdb_WLSJ:"网络数据",
});// 主要覆盖显示，不覆盖控制台日志之类的地方。
let playIdx=0,// 播放索引
	running=false,// 是否正在运行
	noAutoPlayNext=false,
	audioErrorCount=0,// 错误累积计数
	showPlayTime=false,
	preventScreenLock=false;
function filterText(d){// 处理文本
	let t=String(d);
	t=t.replaceAll("&","&amp;");
	t=t.replaceAll("<","&lt;").replaceAll(">","&gt;");
	t=t.replaceAll('"',"&quot;").replaceAll(" ","&nbsp;");
	return t;
}
function changeData(data){// 更新数据
	const msgOpt={zIndex:20,icon:0,anim:6};
	const uit=data.UIText??{};
	if(typeof uit!=="object")return;
	for(const i in uit){
		if(typeof uit[i]!=="string")continue;
		uiText[i]=uit[i];// 若因输错键名导致在严格模式下报错概不负责
	}
	changeUIText(uit);
	const cf=data.call??{};
	if(typeof cf!=="object"){
		layer.msg(filterText(uiText.cd_calldatatypeerr),msgOpt);
		return;
	}
	for(const i in cf){
		setCall(i,cf[i]);
	}
	const list=data.list??[];
	if(!Array.isArray(list)){
		layer.msg(filterText(uiText.cd_playlist_typeerr),msgOpt);
		return;
	}
	if(list.length>0){
		playIdx=0;
		playlist.splice(0);
		audioErrorCount=0;
	}
	const tableData=[];
	for(const i of list){
		docsMonitor.listening["playOneData"]=i;
		if(typeof i!=="object")throw new TypeError("播放列表条目不是对象");
		if(typeof i.title!=="string"){
			docsScript.warn("未提供标题，该播放条目被忽略。","log");
			continue;
		}
		tableData.push(cfgPlayList(i));
	}
	docsMonitor.listening["playOneData"]=undefined;
	if(list.length>0) layui.table.reloadData("playlist",{data:tableData});
	if(playlist.length<1)return;
	changePLIdx(playIdx);
	playAudio(playIdx);
}
function changeUIText(d){// 更新已存在元素的文本
	const gdb=document.getElementById("getdatabutton"),
		sow=document.getElementById("showoptionwin");
	if(gdb&&d.getdatabutton) gdb.textContent=uiText.getdatabutton;
	if(sow&&d.showoptionwin) sow.textContent=uiText.showoptionwin;
	if(d.pl_title||d.pl_type||d.pl_args) layui.table.reload({cols:[[
		{field:'title',title:uiText.pl_title},
		{field:'type',title:uiText.pl_type},
		{field:'args',hide:true,style:'font-family:Consolas,Courier,monospace;',title:uiText.pl_args},
	]]});
}
function setCall(n,t){
	deval.addVar(n,`function ${n} (value){\n\t${t}\n}`);
}
function cfgPlayList(d){// 配置播放列表
	if(typeof d.title!=="string")throw new TypeError("标题不是字符串或未定义");
	const rd={
		title:d.title,
		type:"",
		args:"",
	};
	function st(t){rd.type=d.type=t};
	if(typeof d.url==="string"){
		st("link");
		rd.args=`url="${d.url}"`;
	}else if(hasOwnKey(d,"comment")){
		st("comment");
		rd.args=`comment=${d.comment}`;
	}else if(typeof d.call==="string"&&hasOwnKey(d,"value")){
		st("call");
		rd.args=`call=${d.call},value=${d.value}`;
	}else{
		st("unknow");
	}
	if(rd.type==="unknow"||!rd.type)return undefined;
	playlist.push(d);
	return rd;
}
function showArgs(){
	layui.table.hideCol("playlist",{field:"args",hide:false});
}
function changePLIdx(idx){// 更新播放列表，附带滚动
	layui.table.setRowChecked("playlist",{
		type:"radio",
		index:idx,
	});
	const el=document.querySelector(`[lay-table-id="playlist"] tr[data-index="${idx}"][class="layui-table-checked"]`);
	if(!el)return;
	el.scrollIntoView({behavior:"auto",block:"nearest"});
}
function dfutTtle(){// 重置播放提示
	document.title="audio play";
	id_playtext.textContent=`${uiText.playtext} ${uiText.playtext_none}`;
}
function playAudio(idx){// 播放某个索引对应的音频
	const p=playlist[idx];
	if(typeof p!=="object")throw new TypeError("无效的音频参数数据");
	running=true;
	document.title=`${uiText.playtitle_play} ${p.title}`;
	id_playtext.textContent=`${uiText.playtext} ${p.title}`;
	switch(p.type){
		case "link":
			id_player.src=p.url;
			running=false;
			break;
		case "comment":
		case "unknow":
			running=false;
			playNext();
			break;
		case "call": {
			let v=p.value;
			if(typeof v==="string") v='"'+v.replaceAll('"','\\"')+'"';
			deval.evalCode(`${p.call} (${v})`,Date.now());
			break;
		}
		default:
			running=false;
			layer.msg(filterText(uiText.pa_none_type),{zIndex:20});
			playNext();
	}
}
function playNext(){// 播放下一个
	let nIdx=playIdx+1;
	if(!(nIdx in playlist)){
		nIdx=0;
	}
	playIdx=nIdx;
	changePLIdx(nIdx);
	playAudio(nIdx);
}
function getWakeLock(){// 获取锁定阻止
	if(!preventScreenLock)return;
	if(Temp.PSWL){
		if(!Temp.PSWL.released)return;
		Temp.PSWL=null;
	}
	if(navigator?.wakeLock?.request){
		navigator.wakeLock.request?.("screen").then(w=>{
			Temp.PSWL=w;
			w.onrelease=()=>Temp.PSWL=null;
		}).catch(e=>{
			layer.msg(filterText(uiText.psl_err),{zIndex:20});
			console.error(e);
			cache.log.err.add(30,"getWakeLock",e);
		});
	}else{
		preventScreenLock=false;
	}
}
function clrWakeLock(){// 清除锁定阻止
	if(!Temp.PSWL)return;
	Temp.PSWL.release();
	Temp.PSWL=null;
}
function setWakeLock(){// 设置锁定阻止
	if(preventScreenLock) getWakeLock();
	else clrWakeLock();
}
function getLocalFile(){// 获取本地文件
	const fd="uf_efasdw";
	function success(l,idx){
		const wd=layui.upload.render({
			elem:`[data-k="${fd}"]`,
			url:"about:blank",
			accept:"file",
			acceptMime:"application/json",
			exts:"json",
			auto:false,
			force:"json",
			drag:true,
			choose(obj){
				obj.preview(async(i,f)=>{
					let d=null;
					try{d=JSON.parse(await f.text())}catch(e){cache.log.err.addError(30,"JSON.parse",e)}
					if(!d)return;
					docsMonitor.try(changeData,[d]);
				});
				layer.close(idx);
			}
		});
	}
	layer.open({
		type:1,
		zIndex:10,
		id:"read_file",
		title:filterText(uiText.readfiletitle),
		content:`<div class="layui-upload-drag layui-margin-2" data-k="${fd}">
			<i class="layui-icon layui-icon-upload"></i>
			<div>${filterText(uiText.readfilecontent)}</div>
		</div>`,
		anim:2,
		shadeClose:true,
		success
	});
}
function getNetworkFileWindow(){// 获取网络文件
	layer.prompt({title:filterText(uiText.nw_wwtitle),zIndex:10},(value,index)=>{
		var u="";
		try{u=new URL(value).href;}catch(e){layer.msg(filterText(uiText.nw_urlerr),{zIndex:20});return;}
		getNetworkData(u);
		layer.close(index);
	});
}
function getNetworkData(u){// 请求文件并处理
	const loaidx=layer.msg(filterText(uiText.nw_getting),{
		icon:16,
		shade:0.2,
		zIndex:20
	});
	return fetch(u).then(async r=>{// 只要能解析出数据就算成功，忽略任何非数据的响应问题
		let d=null;
		layer.close(loaidx);
		try{d=await r.json();}catch(e){cache.log.err.addError(30,"JSON.parse",e)}
		if(!d)return;
		docsMonitor.try(changeData,[d]);
	},e=>{
		layer.close(loaidx);
		layer.msg(filterText(uiText.nw_error),{icon:2,shade:0.2,zIndex:20});
	});
}
function playError(){// 播放失败处理
	dfutTtle();
	layer.msg(filterText(`${uiText.pe_msg0} ${playIdx} ${uiText.pe_msg1}\n${uiText.pe_msg2} ${playlist[playIdx].title}`),{zIndex:20});
	audioErrorCount++;
	if(audioErrorCount>10){
		layer.msg(filterText(uiText.pe_errconmax),{zIndex:20});
		audioErrorCount=0;
		return;
	}
	if(noAutoPlayNext){
		clrWakeLock();
		return;
	}
	playNext();
}
function showOptWindow(){// 显示配置窗口
	const form=layui.form;
	function B(v){return Boolean(v)}
	layer.open({
		type:1,
		title:filterText(uiText.opt_title),
		content:`<div class="layui-form layui-margin-3 opt-win-cont" lay-filter="set-opts">
			<input type="checkbox" name="napn" title="${filterText(uiText.opt_NAPN)}" />
			<input type="checkbox" name="spt" title="${filterText(uiText.opt_SPT)}" />
			<input type="checkbox" name="psl" title="${filterText(uiText.opt_PSL)}" />
			<hr />
			<input type="checkbox" name="srn" title="${filterText(uiText.opt_SRN)}" />
		</div>`,
		btn:[filterText(uiText.opt_ok),filterText(uiText.opt_cancel)],
		shade:0.1,
		shadeClose:true,
		id:"set_option",
		zIndex:10,
		resize:true,
		success(){
			form.render(null,"set-opts");
			form.val("set-opts",{
				napn:noAutoPlayNext,
				spt:showPlayTime,
				psl:preventScreenLock,
			});
		},
		btn1(i){
			const d=form.val("set-opts");
			noAutoPlayNext=B(d.napn);
			showPlayTime=B(d.spt);
			preventScreenLock=B(d.psl);
			if(d.srn) running=false;
			layer.close(i);
			setWakeLock();
		},
	})
}
function numToMinTimeStr(n){// 时间数字转为分:秒时间
	const d=Math.trunc(n);
	let m=Math.floor(d/60),
		s=Math.floor(d%60);
	m=(m<10?"0"+m:m);
	s=(s<10?"0"+s:s);
	return m+":"+s;
}
var deval=new DocsEval();
if(DEBUG[0]) cache.runDataReceive.evalMessageEvent=[];
document.getElementById("getdatabutton").onclick=()=>{
	layer.alert(`${filterText(uiText.gdb_XZCZ)}<br /><b><em>注意：</em>请确认使用的是信任的数据，否则可能会出现一些问题。</b>`,{
		zIndex:10,
		shadeClose:true,
		btn:[filterText(uiText.gdb_QX),filterText(uiText.gdb_BDSJ),filterText(uiText.gdb_WLSJ)],
		btnAlign:"c",
		btn2:getLocalFile,
		btn3:getNetworkFileWindow,
	});
}
document.addEventListener("visibilitychange",setWakeLock);
document.getElementById("showoptionwin").onclick=showOptWindow;
deval.setEnv({network:{mode:"HTTPAgent"}});
deval.onmsgerr=deval.onhandleerror=deval.onaddvariableerror=deval.onevalcodeerror=deval.onerrorevent=deval.onunhandledrejection=ev=>{
	const d=ev.data.data;
	console.error("运行代码时出现了错误",d);
	cache.log.err.add(40,"evalcodeError",d);
	running=false;
	playError();
}
deval.onfunctionpush=ev=>{
	const d=ev.data.data;
	let e=false;
	if(typeof d==="string"){
		id_player.src=d;
	}else if(false){
		// 没想好
	}else{
		e=true;
	}
	running=false;
	if(e) playError();
}
layui.table.on("row(playlist)",(o)=>{
	o.setRowChecked({type:"radio"});
	if(running){
		changePLIdx(playIdx);
		layer.msg(filterText(uiText.is_running),{zIndex:20});
		return;
	}
	playIdx=o.index;
	playAudio(playIdx);
});
id_player.onerror=()=>{
	playError();
}
id_player.onended=()=>{
	dfutTtle();
	if(noAutoPlayNext){
		clrWakeLock();
		return;
	}
	playNext();
}
id_player.onplay=()=>{
	document.title=`${uiText.playtitle_play} ${playlist[playIdx].title}`;
	getWakeLock();
}
id_player.onpause=()=>{
	document.title=`${uiText.playtitle_pause} ${playlist[playIdx].title}`;
	clrWakeLock();
}
id_player.ontimeupdate=function(){
	if(!showPlayTime)return;
	let d=-1;
	if(Number.isFinite(this.duration)) d=this.duration;
	id_playtext.textContent=`${uiText.playtext} ${playlist[playIdx].title} (${numToMinTimeStr(this.currentTime)}${d>0?"/"+numToMinTimeStr(d):""})`;
}
if(urlsea.has("href"))for(const h of urlsea.getAll("href")) getNetworkData(h);
if(urlsea.has("lang")) getNetworkData("playlist/"+urlsea.get("lang")+".i18n.json");// 本质上语言文件也是一种播放列表
			//
		</script>
	</body>
</html>
